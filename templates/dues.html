{% extends "base.html" %}

{% block title %}Dues Management - MENTORSCUE{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-md-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="h3 mb-0">Dues Management</h1>
                <div class="btn-group">
                    <button class="btn btn-info" type="button" data-bs-toggle="modal" data-bs-target="#colorLegendModal">
                        <i class="fas fa-info-circle"></i> Color Legend
                    </button>
                </div>
            </div>

            <!-- Tabs -->
            <ul class="nav nav-tabs" id="duesTabs" role="tablist">
                <li class="nav-item" role="presentation">
                    <button class="nav-link active" id="students-tab" data-bs-toggle="tab" data-bs-target="#students" type="button" role="tab">
                        <i class="fas fa-graduation-cap"></i> Students
                    </button>
                </li>
                <li class="nav-item" role="presentation">
                    <button class="nav-link" id="tutors-tab" data-bs-toggle="tab" data-bs-target="#tutors" type="button" role="tab">
                        <i class="fas fa-chalkboard-teacher"></i> Tutors
                    </button>
                </li>
            </ul>

            <!-- Tab Content -->
            <div class="tab-content" id="duesTabsContent">
                <!-- Students Tab -->
                <div class="tab-pane fade show active" id="students" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-0">Student Dues</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <input type="text" class="form-control" id="student-search" placeholder="Search by name...">
                                        <select class="form-select" id="student-filter">
                                            <option value="">All Status</option>
                                            <option value="just_joined">Just Joined</option>
                                            <option value="first_5_days">First 5 Days</option>
                                            <option value="next_5_days">Next 5 Days</option>
                                            <option value="after_10_days">After 10+ Days</option>
                                            <option value="partial_payment">Partial Payment</option>
                                            <option value="paid_attended">Paid & Attended</option>
                                            <option value="paid_no_class">Paid No Class</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="students-table">
                                    <thead>
                                        <tr>
                                            <th>Student Name</th>
                                            <th>Parent Name</th>
                                            <th>Contact</th>
                                            <th>Status</th>
                                            <th>Amount</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="students-tbody">
                                        <!-- Students will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tutors Tab -->
                <div class="tab-pane fade" id="tutors" role="tabpanel">
                    <div class="card">
                        <div class="card-header">
                            <div class="row">
                                <div class="col-md-6">
                                    <h5 class="card-title mb-0">Tutor Dues</h5>
                                </div>
                                <div class="col-md-6">
                                    <div class="d-flex gap-2">
                                        <input type="text" class="form-control" id="tutor-search" placeholder="Search by name...">
                                        <select class="form-select" id="tutor-filter">
                                            <option value="">All Status</option>
                                            <option value="just_joined">Just Joined</option>
                                            <option value="first_5_days">First 5 Days</option>
                                            <option value="next_5_days">Next 5 Days</option>
                                            <option value="after_10_days">After 10+ Days</option>
                                            <option value="paid_attended">Paid & Attended</option>
                                            <option value="paid_no_class">Paid No Class</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table table-striped" id="tutors-table">
                                    <thead>
                                        <tr>
                                            <th>Tutor Name</th>
                                            <th>Mobile</th>
                                            <th>Status</th>
                                            <th>Earnings</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody id="tutors-tbody">
                                        <!-- Tutors will be loaded here -->
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Color Legend Modal -->
<div class="modal fade" id="colorLegendModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Dues Status Color Legend</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div class="col-md-6">
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_just_joined', '#ffffff') }}; border: 1px solid #ddd;">
                            <strong>Just Joined</strong><br>
                            <small>Before first invoice</small>
                        </div>
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_first_5_days', '#fff3cd') }};">
                            <strong>First 5 Days</strong><br>
                            <small>First 5 days after invoice</small>
                        </div>
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_next_5_days', '#ffeaa7') }};">
                            <strong>Next 5 Days</strong><br>
                            <small>Next 5 days overdue</small>
                        </div>
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_after_10_days', '#ff6b6b') }}; color: white;">
                            <strong>After 10+ Days</strong><br>
                            <small>After 10+ days overdue</small>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_partial_payment', '#e17055') }}; color: white;">
                            <strong>Partial Payment</strong><br>
                            <small>Partial payment made</small>
                        </div>
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_paid_attended', '#00b894') }}; color: white;">
                            <strong>Paid & Attended</strong><br>
                            <small>Paid and attended class</small>
                        </div>
                        <div class="p-3 mb-2 rounded" style="background-color: {{ Settings.get_setting('dues_colors_paid_no_class', '#006663') }}; color: white;">
                            <strong>Paid No Class</strong><br>
                            <small>Paid but no class taken</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Status Update Modal -->
<div class="modal fade" id="statusUpdateModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Update Status</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="status-update-form" method="POST" action="{{ url_for('update_dues_status') }}">
                    <input type="hidden" id="entity-type" name="entity_type">
                    <input type="hidden" id="entity-id" name="entity_id">
                    
                    <div class="mb-3">
                        <label class="form-label">New Status</label>
                        <select class="form-select" id="new-status" name="new_status" required>
                            <option value="">Select Status</option>
                            <option value="paid">Mark as Paid</option>
                            <option value="partial">Mark as Partial</option>
                            <option value="due">Mark as Due</option>
                        </select>
                    </div>
                    
                    <div class="mb-3" id="amount-section" style="display: none;">
                        <label class="form-label">Amount Paid</label>
                        <input type="number" class="form-control" id="amount-paid" name="amount_paid" step="0.01" min="0">
                    </div>
                    
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                        <button type="submit" class="btn btn-primary">Update Status</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const statusColors = {
        'just_joined': '{{ Settings.get_setting("dues_colors_just_joined", "#ffffff") }}',
        'first_5_days': '{{ Settings.get_setting("dues_colors_first_5_days", "#fff3cd") }}',
        'next_5_days': '{{ Settings.get_setting("dues_colors_next_5_days", "#ffeaa7") }}',
        'after_10_days': '{{ Settings.get_setting("dues_colors_after_10_days", "#ff6b6b") }}',
        'partial_payment': '{{ Settings.get_setting("dues_colors_partial_payment", "#e17055") }}',
        'paid_attended': '{{ Settings.get_setting("dues_colors_paid_attended", "#00b894") }}',
        'paid_no_class': '{{ Settings.get_setting("dues_colors_paid_no_class", "#006663") }}'
    };
    
    let studentsData = [];
    let tutorsData = [];
    
    // Load students data
    function loadStudents() {
        fetch('/dues/students')
            .then(response => response.json())
            .then(data => {
                studentsData = data.students;
                renderStudents(studentsData);
            })
            .catch(error => {
                console.error('Error loading students:', error);
            });
    }
    
    // Load tutors data
    function loadTutors() {
        fetch('/dues/tutors')
            .then(response => response.json())
            .then(data => {
                tutorsData = data.tutors;
                renderTutors(tutorsData);
            })
            .catch(error => {
                console.error('Error loading tutors:', error);
            });
    }
    
    // Render students table
    function renderStudents(students) {
        const tbody = document.getElementById('students-tbody');
        tbody.innerHTML = '';
        
        students.forEach(student => {
            const row = document.createElement('tr');
            const statusColor = statusColors[student.status] || '#ffffff';
            const textColor = ['after_10_days', 'partial_payment', 'paid_attended', 'paid_no_class'].includes(student.status) ? 'white' : 'black';
            
            row.innerHTML = `
                <td>${student.name}</td>
                <td>${student.parent_name}</td>
                <td>${student.parent_whatsapp}</td>
                <td>
                    <span class="badge" style="background-color: ${statusColor}; color: ${textColor};">
                        ${student.status.replace('_', ' ').toUpperCase()}
                    </span>
                </td>
                <td>₹${student.total_amount.toFixed(2)} (Paid: ₹${student.amount_paid.toFixed(2)})</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal('student', ${student.id})">
                        <i class="fas fa-edit"></i> Update
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // Render tutors table
    function renderTutors(tutors) {
        const tbody = document.getElementById('tutors-tbody');
        tbody.innerHTML = '';
        
        tutors.forEach(tutor => {
            const row = document.createElement('tr');
            const statusColor = statusColors[tutor.status] || '#ffffff';
            const textColor = ['after_10_days', 'partial_payment', 'paid_attended', 'paid_no_class'].includes(tutor.status) ? 'white' : 'black';
            
            row.innerHTML = `
                <td>${tutor.name}</td>
                <td>${tutor.mobile}</td>
                <td>
                    <span class="badge" style="background-color: ${statusColor}; color: ${textColor};">
                        ${tutor.status.replace('_', ' ').toUpperCase()}
                    </span>
                </td>
                <td>₹${tutor.total_earnings.toFixed(2)}</td>
                <td>
                    <button class="btn btn-sm btn-outline-primary" onclick="openStatusModal('tutor', ${tutor.id})">
                        <i class="fas fa-edit"></i> Update
                    </button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }
    
    // Search functionality
    document.getElementById('student-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredStudents = studentsData.filter(student => 
            student.name.toLowerCase().includes(searchTerm) ||
            student.parent_name.toLowerCase().includes(searchTerm)
        );
        renderStudents(filteredStudents);
    });
    
    document.getElementById('tutor-search').addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const filteredTutors = tutorsData.filter(tutor => 
            tutor.name.toLowerCase().includes(searchTerm) ||
            tutor.mobile.includes(searchTerm)
        );
        renderTutors(filteredTutors);
    });
    
    // Filter functionality
    document.getElementById('student-filter').addEventListener('change', function() {
        const filterValue = this.value;
        const filteredStudents = filterValue ? 
            studentsData.filter(student => student.status === filterValue) : 
            studentsData;
        renderStudents(filteredStudents);
    });
    
    document.getElementById('tutor-filter').addEventListener('change', function() {
        const filterValue = this.value;
        const filteredTutors = filterValue ? 
            tutorsData.filter(tutor => tutor.status === filterValue) : 
            tutorsData;
        renderTutors(filteredTutors);
    });
    
    // Status update modal
    document.getElementById('new-status').addEventListener('change', function() {
        const amountSection = document.getElementById('amount-section');
        if (this.value === 'partial') {
            amountSection.style.display = 'block';
            document.getElementById('amount-paid').required = true;
        } else {
            amountSection.style.display = 'none';
            document.getElementById('amount-paid').required = false;
        }
    });
    
    // Load data on page load
    loadStudents();
    loadTutors();
    
    // Refresh data when tab is switched
    document.getElementById('tutors-tab').addEventListener('shown.bs.tab', function() {
        loadTutors();
    });
    
    document.getElementById('students-tab').addEventListener('shown.bs.tab', function() {
        loadStudents();
    });
});

// Open status update modal
function openStatusModal(entityType, entityId) {
    document.getElementById('entity-type').value = entityType;
    document.getElementById('entity-id').value = entityId;
    document.getElementById('new-status').value = '';
    document.getElementById('amount-section').style.display = 'none';
    document.getElementById('amount-paid').value = '';
    
    const modal = new bootstrap.Modal(document.getElementById('statusUpdateModal'));
    modal.show();
}
</script>

<style>
.nav-tabs .nav-link {
    color: #344e80;
    font-weight: 500;
}

.nav-tabs .nav-link.active {
    background-color: #344e80;
    color: white;
    border-color: #344e80;
}

.badge {
    font-size: 0.75rem;
    font-weight: 500;
    padding: 0.5rem 1rem;
    border-radius: 20px;
}

.table th {
    background-color: #f8f9fa;
    font-weight: 600;
    color: #344e80;
}

.btn-outline-primary {
    color: #344e80;
    border-color: #344e80;
}

.btn-outline-primary:hover {
    background-color: #344e80;
    border-color: #344e80;
}

.form-control:focus, .form-select:focus {
    border-color: #344e80;
    box-shadow: 0 0 0 0.2rem rgba(52, 78, 128, 0.25);
}

.card {
    border: none;
    box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
}

.modal-header {
    background-color: #f8f9fa;
    border-bottom: 1px solid #dee2e6;
}

.modal-title {
    color: #344e80;
    font-weight: 600;
}
</style>
{% endblock %}